<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <script type="text/javascript">

    // 고객사 식별 (SDK 초기화)
    const IMP = window.IMP;
    IMP.init("imp72580830");

    function doPayment() {
      // 결제창 호출
      IMP.request_pay({
        pg: "uplus",
        pay_method: "card",
        merchant_uid: "ticket:3:" + new Date().getTime(), // 주문 '고유' 번호 // "iamporttest_17"
        name: "Musical", // show.title
        amount: 23000, // show.price
        buyer_email: "modify@sample.com", // user.email
        buyer_name: "Charlie", // user.nickname
        notice_url: "http://localhost:3000/payments/webhook" // Webhook 수신 URL 설정
      }, async function (response) { // 결제 후 호출되는 callback 로직
        console.log(response);
        if (response.success) { // 결제 성공
          alert('결제 성공 : ' + response.paid_amount);

          // 결제 결과 처리
          try {
            // 고객사 서버에서 /payment/complete 엔드포인트를 구현해야 함
            const notified = await fetch('http://localhost:3000/payments/complete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              // imp_uid와 merchant_uid, 주문 정보를 서버에 전달
              body: JSON.stringify({
                imp_uid: response.imp_uid, // portone 결제 id
                merchant_uid: response.merchant_uid, // 고객사 주문 '고유' 번호
                // 주문 정보 ...
              }),
            });

            const data = await notified.json();
            alert(data.message);
          } catch (err) {
            alert('결제 검증 실패 : ' + err.message);
          }
        } else { // 결제 실패
          alert('결제 실패 : ' + response.error_msg);
        }
      });
    }
  </script>
</head>

<body>
  <!-- 결제하기 버튼 -->
  <button onclick="doPayment()">결제하기</button>
</body>

</html>