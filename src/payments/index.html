<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <script type="text/javascript">

    // 고객사 식별 (SDK 초기화)
    const IMP = window.IMP;
    IMP.init("imp72580830");

    function doPayment() {
      // 결제창 호출
      IMP.request_pay({
        pg: "uplus",
        pay_method: "card",
        merchant_uid: "iamporttest_15", // 주문 '고유' 번호
        name: "Musical",
        amount: 100,
        buyer_email: "modify@sample.com",
        buyer_name: "Charlie"
      }, async function (response) { // 결제 후 호출되는 callback 로직
        console.log(response);
        if (response.success) { // 결제 성공
          alert('결제 성공 : ' + response.paid_amount);

          // 결제 결과 처리
          try {
            const notified = await fetch('/payment/complete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                imp_uid: response.imp_uid, // portone 결제 id
                merchant_uid: response.merchant_uid, // 고객사 주문 '고유' 번호
              }),
            });

            const data = await notified.json();
            alert(data.message);
          } catch (err) {
            alert('결제 검증 실패 : ' + err.message);
          }
        } else { // 결제 실패
          alert('결제 실패 : ' + response.error_msg);
        }
      });
    }
  </script>
</head>

<body>
  <!-- 결제하기 버튼 -->
  <button onclick="doPayment()">결제하기</button>
</body>

</html>